<!DOCTYPE html>

<head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script language="javascript" type="text/javascript">

        let connectionEstablished = false;

        let REQUEST_CODES = {
            'MESSAGE_SEND': 250,
            'HELLO': 600,
            'PING': 888,
            'ROUTE_CHANGE': 900,
            'PRESENCE_CHECK': 950,
        };

        let RESPONSE_CODES = {
            'HELLO_OK_1': 200,
            'HELLO_OK_2': 201,
            'MESSAGE_DELIVERED': 260,
            'ERROR': 500,
            'REJECT': 503,
            'MESSAGE_FAILED': 505,
            'PONG': 889,
            'PRESENCE_RESPONSE': 951
        };

        function init() {
            document.myform.port.value = 64214;
            document.myform.inputtext.value = '';
            document.myform.disconnectButton.disabled = true;
            document.myform.checkButton.disabled = true;
        }

        function doConnect() {
            websocket = new WebSocket('ws://localhost:' + document.myform.port.value+'/');
            websocket.onopen = function(evt) { onOpen(evt) };
            websocket.onclose = function(evt) { onClose(evt) };
            websocket.onmessage = function(evt) { onMessage(evt) };
            websocket.onerror = function(evt) { onError(evt) };
        }

        function onOpen(evt) {
            writeToScreen("---Connection with server established---\n");
            document.myform.connectButton.disabled = true;
            document.myform.checkButton.disabled = false;
            document.myform.disconnectButton.disabled = false;
            doSend(createMessage(REQUEST_CODES.HELLO, document.myform.userName.value.length ,document.myform.userName.value))
        }

        function onClose(evt) {
            writeToScreen("---Connection with server lost---\n");
            document.myform.connectButton.disabled = false;
            document.myform.disconnectButton.disabled = true;
        }

        function onMessage(evt) {
            console.log(evt.data);
            writeToScreen("response: " + evt.data + '\n');
            let message = parseMessage(evt.data);
            if (parseInt(message['code']) === RESPONSE_CODES.HELLO_OK_1) {
                doSend(createMessage(RESPONSE_CODES.HELLO_OK_2, 0 ,""));
                connectionEstablished = true;
            }
        }

        function parseMessage(data) {
            let code = parseInt(data)
            let trimmedData = data.substring(data.indexOf(" "), data.length);
            let messageLength = parseInt(trimmedData);
            trimmedData = data.substring(data.indexOf(" "), data.length).trim();
            let messageContent = trimmedData.substring(trimmedData.indexOf(" "), trimmedData.length).trim();

            return {
                'code': code,
                'messageLength': messageLength,
                'messageContent': messageContent
            }
        }

        function onError(evt) {
            writeToScreen('error: ' + evt.data + '\n');
            websocket.close();
            document.myform.connectButton.disabled = false;
            document.myform.disconnectButton.disabled = true;
        }

        function doSend(message) {
            let parsedMessage = parseMessage(message);

            if (parseInt(parsedMessage['code']) === REQUEST_CODES.MESSAGE_SEND) {
                writeToScreen("sent: " + parsedMessage['messageContent'] + '\n');
            }
            websocket.send(message);
        }

        function writeToScreen(message) {
            document.myform.outputtext.value += message
            document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;
        }

        window.addEventListener("load", init, false);


        function sendMessage() {
            let messageContent = document.myform.inputtext.value;
            let messageLength = messageContent.length;

            if (connectionEstablished) {
                doSend(createMessage(REQUEST_CODES.MESSAGE_SEND, messageLength, messageContent));
            }
        }

        function createMessage(code, length, content) {
            let message = code + " " + length + " " + content;
            console.log(message);
            return (message);
        }

        function clearText() {
            document.myform.outputtext.value = "";
        }

        function doDisconnect() {
            websocket.close();
        }

        function checkIfUserConnected() {
            let userToCheck = document.myform.inputtext.userToCheck;
            doSend(createMessage(REQUEST_CODES.PRESENCE_CHECK, userToCheck.length, userToCheck));
        }

    </script>
</head>

<body>
    <div class="container mt-5">
        <form name="myform">
            <div class="alert alert-info">
                <strong>CHAT APPLICATION!</strong>
            </div>
            <div class="form-group">
                <label for="userName">Choose your name:</label>
                <input type="text" class="form-control" name="userName" id="userName">
            </div>

            <div class="my-3">
                <input type="button" class="btn btn-primary" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
                <input type="button" class="btn btn-primary" name=connectButton value="Connect" onClick="doConnect();">
            </div>


            <p><textarea name="outputtext" rows="20" cols="120"></textarea></p>

            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label for="message">Type your message:</label>
                        <input type="text" class="form-control" name="inputtext" id="message">
                    </div>
                    <p><input type="button" class="btn btn-primary" name=sendButton value="Send" onClick="sendMessage();"></p>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label for="recipient">Recipient:</label>
                        <input type="text" class="form-control" name="recipient" id="recipient">
                    </div>
                    <p><input type="button" class="btn btn-primary" name=checkButton value="Check user" onClick="checkIfUserConnected();"></p>
                </div>
            </div>
            <p><input hidden="true" type="text" name="port"/></p>
        </form>
    </div>
</body>
</html>
